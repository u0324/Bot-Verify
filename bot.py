import os
import requests
import threading
import time
import psycopg2 
import pandas as pd
from flask import Flask, jsonify, request
from datetime import datetime
import pytz 
from discord_interactions import verify_key, InteractionType, InteractionResponseType

app = Flask(__name__)

# --- Secrets (Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæó) ---
DATABASE_URL = os.getenv('DATABASE_URL') 
DISCORD_PUBLIC_KEY = os.getenv('DISCORD_PUBLIC_KEY')
APPLICATION_ID = os.getenv('APPLICATION_ID') 
DISCORD_BOT_TOKEN = os.getenv('DISCORD_BOT_TOKEN')
YOUR_USER_ID = '1421704357983813744'

timezone_jp = pytz.timezone('Asia/Tokyo')

def get_db_connection():
    return psycopg2.connect(DATABASE_URL)

# --- üì• „Éé„Éº„Éà„Åã„ÇâË™≠„ÅøÂèñ„Å£„Åü‰∏ÄÊã¨„Éá„Éº„Çø („Åì„Åì„Å´ÂÖ®„Éá„Éº„Çø„Çí„Åæ„Å®„ÇÅ„Åæ„Åó„Åü) ---
RAW_DATA = [
    ("2025/11/09 06:00", 542), ("2025/11/09 10:00", 538), ("2025/11/09 16:00", 550), ("2025/11/09 19:00", 488), ("2025/11/09 22:00", 465),
    ("2025/11/10 05:00", 361), ("2025/11/10 08:00", 461), ("2025/11/10 11:00", 499), ("2025/11/10 14:00", 546), ("2025/11/10 17:00", 511), ("2025/11/10 21:00", 473), ("2025/11/11 00:00", 488),
    ("2025/11/11 03:00", 457), ("2025/11/11 06:00", 415), ("2025/11/11 09:00", 411), ("2025/11/11 12:00", 442), ("2025/11/11 16:00", 442), ("2025/11/11 19:00", 469), ("2025/11/11 22:00", 355),
    ("2025/11/12 01:00", 326), ("2025/11/12 04:00", 380), ("2025/11/12 07:00", 323), ("2025/11/12 11:00", 307), ("2025/11/12 14:00", 287), ("2025/11/12 17:00", 292), ("2025/11/12 20:00", 286),
    ("2025/11/13 02:00", 325), ("2025/11/13 06:00", 319), ("2025/11/13 09:00", 407), ("2025/11/13 12:00", 380), ("2025/11/13 15:00", 347), ("2025/11/13 18:00", 407), ("2025/11/13 21:00", 400),
    ("2025/11/14 01:00", 366), ("2025/11/14 04:00", 382), ("2025/11/14 07:00", 367), ("2025/11/14 10:00", 362), ("2025/11/14 13:00", 390), ("2025/11/14 16:00", 350), ("2025/11/14 20:00", 367), ("2025/11/14 23:00", 352),
    ("2025/11/15 02:00", 352), ("2025/11/15 05:00", 337), ("2025/11/15 08:00", 315), ("2025/11/15 11:00", 330), ("2025/11/15 15:00", 320), ("2025/11/15 18:00", 302), ("2025/11/15 21:00", 307),
    ("2025/11/16 00:00", 284), ("2025/11/16 03:00", 265), ("2025/11/16 06:00", 267), ("2025/11/16 10:00", 260), ("2025/11/16 13:00", 235), ("2025/11/16 16:00", 212), ("2025/11/16 19:00", 210), ("2025/11/16 22:00", 220),
    ("2025/11/17 02:00", 212), ("2025/11/17 05:00", 160), ("2025/11/17 08:00", 142), ("2025/11/17 11:00", 120), ("2025/11/17 14:00", 112), ("2025/11/17 17:00", 128), ("2025/11/17 21:00", 115),
    ("2025/11/21 23:00", 105), ("2025/11/22 02:00", 100), ("2025/11/22 05:00", 102), ("2025/11/22 08:00", 99), ("2025/11/22 12:00", 97), ("2025/11/22 15:00", 95), ("2025/11/22 18:00", 90), ("2025/11/22 21:00", 86),
    ("2025/11/23 00:00", 95), ("2025/11/23 03:00", 85), ("2025/11/23 07:00", 63), ("2025/11/23 10:00", 82), ("2025/11/23 13:00", 85), ("2025/11/23 16:00", 90), ("2025/11/23 19:00", 90), ("2025/11/23 22:00", 100),
    ("2025/11/24 02:00", 99), ("2025/11/24 05:00", 100), ("2025/11/24 08:00", 112), ("2025/11/24 11:00", 110), ("2025/11/24 14:00", 110), ("2025/11/24 17:00", 112), ("2025/11/24 21:00", 107),
    ("2025/11/25 03:00", 108), ("2025/11/25 06:00", 114), ("2025/11/25 09:00", 125), ("2025/11/25 12:00", 122), ("2025/11/25 14:00", 127), ("2025/11/25 22:00", 132),
    ("2025/11/26 04:00", 132), ("2025/11/26 07:00", 122), ("2025/11/26 11:00", 135), ("2025/11/26 17:00", 125), ("2025/11/26 20:00", 130), ("2025/11/26 23:00", 127),
    ("2025/11/27 02:00", 125), ("2025/11/27 06:00", 125), ("2025/11/27 09:00", 112), ("2025/11/27 12:00", 209), ("2025/11/27 15:00", 179),
    ("2025/11/28 04:00", 178), ("2025/11/28 07:00", 212), ("2025/11/28 17:00", 275), ("2025/11/28 20:00", 255), ("2025/11/28 23:00", 220),
    ("2025/11/29 02:00", 310), ("2025/11/29 05:00", 295), ("2025/11/29 08:00", 267), ("2025/11/29 15:00", 210), ("2025/11/29 18:00", 204), ("2025/11/29 21:00", 227),
    ("2025/11/30 00:00", 236), ("2025/11/30 07:00", 210), ("2025/11/30 10:00", 215), ("2025/11/30 13:00", 201), ("2025/11/30 16:00", 185), ("2025/11/30 19:00", 212), ("2025/11/30 22:00", 223),
    ("2025/12/21 19:00", 548), ("2025/12/21 22:00", 586), ("2026/01/27 23:00", 100)
]

def handle_bulk_import(token, application_id):
    conn = get_db_connection()
    cur = conn.cursor()
    # Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ‰ª•‰∏ã„ÇíÊúâÂäπ„Å´Ôºà‰ªä„ÅØËøΩË®ò„É¢„Éº„ÉâÔºâ
    # cur.execute("DELETE FROM history")
    
    count = 0
    for ts_str, price in RAW_DATA:
        ts = timezone_jp.localize(datetime.strptime(ts_str, "%Y/%m/%d %H:%M"))
        cur.execute("INSERT INTO history (timestamp, price, month, day, hour) VALUES (%s, %s, %s, %s, %s)",
                    (ts, float(price), ts.month, ts.day, ts.hour))
        count += 1
    
    conn.commit()
    conn.close()
    
    url = f"https://discord.com/api/v10/webhooks/{application_id}/{token}/messages/@original"
    requests.patch(url, json={"content": f"‚úÖ „Éé„Éº„Éà„Åã„ÇâË™≠„ÅøÂèñ„Å£„ÅüÈÅéÂéª„Éá„Éº„Çø **{count}‰ª∂** „ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅAI„ÅÆÂ≠¶Áøí„ÅåÂ§ßÂπÖ„Å´Âº∑Âåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇ"})

@app.route('/', methods=['POST'])
def interactions():
    data = request.json
    if data.get('type') == InteractionType.PING: return jsonify({'type': InteractionResponseType.PONG})

    user = data.get('member', {}).get('user', {}) or data.get('user', {})
    if user.get('id') != YOUR_USER_ID: return jsonify({'type': InteractionResponseType.PONG})

    if data.get('type') == InteractionType.APPLICATION_COMMAND:
        cmd_name = data['data']['name']
        if cmd_name == 'bulk_import':
            threading.Thread(target=handle_bulk_import, args=(data.get('token'), APPLICATION_ID)).start()
            return jsonify({'type': InteractionResponseType.DEFERRED_CHANNEL_MESSAGE_WITH_SOURCE})

    return jsonify({'type': InteractionResponseType.PONG})

def register_commands():
    base_url = f"https://discord.com/api/v10/applications/{APPLICATION_ID}/commands"
    headers = {"Authorization": f"Bot {DISCORD_BOT_TOKEN}"}
    commands = [{"name": "bulk_import", "description": "„Éé„Éº„Éà„ÅÆÈÅéÂéª„Éá„Éº„Çø„Çí‰∏ÄÊã¨ÁôªÈå≤"}]
    requests.put(base_url, json=commands, headers=headers)

if __name__ == '__main__':
    threading.Thread(target=register_commands).start()
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))
